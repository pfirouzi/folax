import pytest
import unittest 
import os
import numpy as np
from fol.loss_functions.mechanical_neohooke_AD import NeoHookeMechanicalLoss2DQuad
from fol.loss_functions.mechanical_neohooke_AD import NeoHookeMechanicalLoss3DTetra
from fol.loss_functions.mechanical_neohooke_AD import NeoHookeMechanicalLoss3DHexa
from fol.tools.usefull_functions import *

class TestMechanical3D(unittest.TestCase):

    @pytest.fixture(autouse=True)
    def _request_debug_mode(self,request):
        self.debug_mode = request.config.getoption('--debug-mode')

    def test_tetra(self):

        tet_points_coordinates = jnp.array([[0.1, 0.1, 0.1],
                                            [0.28739360416666665, 0.27808503701741405, 0.05672979583333333],
                                            [0.0, 1.0, 0.0],
                                            [0.0, 1.0, 0.1]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(tet_points_coordinates))
        fe_mesh.nodes_coordinates = tet_points_coordinates
        fe_mesh.elements_nodes = {"tetra":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DTetra("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                                       "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                                                       "body_foce":jnp.array([[1],[2],[3]])},
                                                                                        fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()
        
        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(tet_points_coordinates,
                                                                        jnp.ones((4)),
                                                                        jnp.ones((12,1)))
        
        np.testing.assert_allclose(stiffness,jnp.array([[7.719868482196064197e-02,3.447412185357874581e-02,3.708021913375659970e-18,-8.858663352179195483e-02,-3.763646372794507422e-02,-2.531456824313683906e-18,3.833161718925617856e-02,1.628537469619531150e-02,3.856383349265945365e-02,-2.694366848942483100e-02,-1.312303282182897095e-02,-3.856383349265945365e-02],
                                                            [3.447412185357878051e-02,6.463441758461145603e-02,1.476159709463893099e-18,-1.733731842879979515e-02,-7.079636262197117058e-02,-1.007770357780162108e-18,7.501893081166852682e-03,3.063373064910061838e-02,1.535222244480059089e-02,-2.463869650594581462e-02,-2.447178561174091424e-02,-1.535222244480059089e-02],
                                                            [2.796420178800879884e-17,7.319476401824932367e-18,6.226819130044627948e-02,-2.937916752980236199e-17,-3.639266400755902674e-19,-6.997302269726186907e-02,1.851064007647657272e-01,7.369066773504281964e-02,3.027746978269324485e-02,-1.851064007647657550e-01,-7.369066773504280576e-02,-2.257263838587766566e-02],
                                                            [-8.858663352179198258e-02,-1.733731842879976739e-02,8.606294082982483654e-19,1.077757038378668736e-01,1.495452349903417938e-02,-3.680093449329389700e-18,-4.663476709270703013e-02,-6.470852850184258959e-03,-4.807692307692298939e-02,2.744569677663206975e-02,8.853647779949831362e-03,4.807692307692299633e-02],
                                                            [-3.763646372794512279e-02,-7.079636262197117058e-02,1.669283775063773312e-18,1.495452349903424356e-02,8.485689387766130742e-02,-4.088992721477123741e-19,-6.470852850184317072e-03,-3.671775123035571353e-02,-5.341880341880398363e-03,2.915279307909519543e-02,2.265721997466558016e-02,5.341880341880396628e-03],
                                                            [-3.063620948428898877e-17,-5.176025051044826605e-18,-6.997302269726184132e-02,3.135765848958965856e-17,1.041465187197535547e-18,8.457040875315871564e-02,-2.307692307692308931e-01,-2.564102564102570606e-02,-3.659378853207633647e-02,2.307692307692308931e-01,2.564102564102571299e-02,2.199640247617947256e-02],
                                                            [3.833161718925622713e-02,7.501893081166837070e-03,1.851064007647657272e-01,-4.663476709270707871e-02,-6.470852850184289316e-03,-2.307692307692308376e-01,3.787611655716282000e-01,2.799951239599322329e-03,1.206573000801283851e-01,-3.704580156681773206e-01,-3.830991470581864879e-03,-7.499447007566324708e-02],
                                                            [1.628537469619534619e-02,3.063373064910064267e-02,7.369066773504280576e-02,-6.470852850184304929e-03,-3.671775123035572047e-02,-2.564102564102570606e-02,2.799951239599342712e-03,3.744700525607480013e-01,1.340636667557004030e-02,-1.261447308561038268e-02,-3.683860319794929339e-01,-6.145600876958714348e-02],
                                                            [3.856383349265956467e-02,1.535222244480059436e-02,3.027746978269316158e-02,-4.807692307692302408e-02,-5.341880341880359331e-03,-3.659378853207626014e-02,1.206573000801282741e-01,1.340636667556988244e-02,4.740225821586572796e-01,-1.111442104958647037e-01,-2.341670877849008972e-02,-4.677062634092741811e-01],
                                                            [-2.694366848942490039e-02,-2.463869650594581462e-02,-1.851064007647657272e-01,2.744569677663215648e-02,2.915279307909518156e-02,2.307692307692308376e-01,-3.704580156681773206e-01,-1.261447308561037400e-02,-1.111442104958648702e-01,3.699559873809701305e-01,8.100376512461003597e-03,6.548138049139973216e-02],
                                                            [-1.312303282182900391e-02,-2.447178561174093853e-02,-7.369066773504280576e-02,8.853647779949860852e-03,2.265721997466557322e-02,2.564102564102570606e-02,-3.830991470581877022e-03,-3.683860319794929339e-01,-2.341670877849023891e-02,8.100376512461003597e-03,3.702005976165682610e-01,7.146635087250734208e-02],
                                                            [-3.856383349265956467e-02,-1.535222244480059089e-02,-2.257263838587758933e-02,4.807692307692301714e-02,5.341880341880358464e-03,2.199640247617939276e-02,-7.499447007566314993e-02,-6.145600876958699083e-02,-4.677062634092741811e-01,6.548138049139956562e-02,7.146635087250718943e-02,4.682824993189723117e-01]
                                                            ])
                                    ,rtol=1e-5, atol=1e-6)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([3.850731904736891774e-03,
                                                                    2.884104646115655409e-04,
                                                                    -2.330784343146762548e-03,
                                                                    -6.546158883613030673e-03,
                                                                    -2.194881869790161859e-03,
                                                                    -2.330784343146770788e-03,
                                                                    1.719429818310064858e-03,
                                                                    -1.276483125132017943e-03,
                                                                    9.621955878118709435e-03,
                                                                    -2.131715296962949195e-03,
                                                                    -3.032470384747431615e-03,
                                                                    -1.428352456441224320e-02
                                                                    ])
                                   ,rtol=1e-5, atol=1e-6)

    def test_hexa(self):
        hex_points_coordinates = jnp.array([[0.24900,  0.34200,  0.19200],
                                            [0.32000,  0.18600,  0.64300],
                                            [0.16500,  0.74500,  0.70200],
                                            [0.27300,  0.75000,  0.23000],
                                            [0.00000,  0.00000,  0.00000],
                                            [0.00000,  0.00000,  1.00000],
                                            [0.00000,  1.00000,  1.00000],
                                            [0.00000,  1.00000,  0.00000]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(hex_points_coordinates))
        fe_mesh.nodes_coordinates = hex_points_coordinates
        fe_mesh.elements_nodes = {"hexahedron":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DHexa("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                  "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                  "body_foce":jnp.array([[1],[2],[3]])},
                                                   fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(hex_points_coordinates,
                                                                        jnp.ones((8)),
                                                                        jnp.ones((24,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[5.480671106767268652e-01,-9.673765943449662286e-02,-1.239915424537360589e-01,1.032102827735144890e-01,-3.786349277998325713e-02,-9.898983993853484320e-02,-2.155366966905074289e-02,-3.278382074899849341e-02,-3.950231208311035663e-02,9.382547808695919367e-02,-6.222694776158609054e-02,-2.421457223105456802e-02,-2.760697613587251853e-01,4.798160466503322702e-02,7.421414414557879480e-02,-1.425807898618721148e-01,2.876709545186384789e-02,1.040767531379037381e-01,-9.222081798683316733e-02,5.147920116805049240e-02,5.832223893447671670e-02,-2.126778326607192127e-01,1.013840194401168515e-01,5.008513048847666044e-02],
                                                            [-9.673765943449656735e-02,4.541131832941750490e-01,4.385556025493178578e-02,-3.096178337827377308e-02,7.963597406008335322e-02,2.333005200308480714e-02,9.133914293736545426e-03,-2.989177243328788175e-02,-4.883053538175002872e-02,7.428480437516603307e-02,5.965668511023124870e-02,-3.783374654386957581e-02,-9.543185687342831125e-02,-2.035095638001865048e-01,2.586723357262283793e-02,-3.649465668488827835e-02,-1.112528010335459977e-01,2.387447117153721973e-02,5.147920116805046464e-02,-7.663920172983119949e-02,-1.652376506273955936e-02,1.247280365341338626e-01,-1.721125034676380672e-01,-1.373927001381748669e-02],
                                                            [-1.239915424537361560e-01,4.385556025493178578e-02,4.595962120874740875e-01,5.274627117257617293e-02,-2.112507620204335038e-02,6.572943750840570809e-02,1.774127766047934804e-02,-4.406023623645088927e-02,-3.236730661571426276e-02,-1.721136710284941820e-02,1.139168080655774025e-02,7.245258498973951300e-02,-8.452517209373731910e-02,2.109693442732369154e-02,-2.026377933537866494e-01,1.229549582661088603e-01,-8.604161307095251066e-03,-1.191887978535797199e-01,5.832223893447673058e-02,-1.652376506273956630e-02,-7.778575511246051122e-02,-2.603666438331819419e-02,1.396906331951584292e-02,-1.657985816500781584e-01],
                                                            [1.032102827735144474e-01,-3.096178337827381472e-02,5.274627117257621456e-02,5.257747641674592742e-01,-7.665200050276198274e-02,1.082279422395874130e-01,1.786789482203773038e-01,-7.309160512792010900e-02,5.013223673108321149e-02,6.450856771395609320e-03,-1.744234773560118454e-02,1.408521631713536074e-02,-2.369431636514482131e-01,3.059710848067076147e-02,-9.858563260022125407e-02,-2.693307064348813840e-01,2.621498587231785998e-02,-4.052398326006814017e-02,-1.705622753100510258e-01,8.433895963857489242e-02,-2.867186384259902757e-02,-1.372787065363660908e-01,5.699668275299362569e-02,-5.741018675749381961e-02],
                                                            [-3.786349277998318774e-02,7.963597406008335322e-02,-2.112507620204335732e-02,-7.665200050276185784e-02,4.261067137355706302e-01,-2.681767762630433635e-02,8.706865128233626239e-02,1.298505892409671236e-01,2.474093967817626166e-02,3.432047277721930745e-02,-5.028907042642480688e-03,3.574925189680255855e-02,-5.141143852787627422e-02,-1.845446372622161213e-01,-1.530657763972284070e-02,-1.270435611362292494e-01,-1.995455388125259855e-01,-2.409363137750261674e-02,1.145846861343013667e-01,-1.348167655509485696e-01,9.582111798331013203e-03,5.699668275299361181e-02,-1.116574283682880558e-01,1.727065947226330903e-02],
                                                            [-9.898983993853488483e-02,2.333005200308481755e-02,6.572943750840577748e-02,1.082279422395875240e-01,-2.681767762630434329e-02,4.287253285000310887e-01,5.946984356869014499e-02,-2.823982955259293076e-02,1.430983448642634270e-01,-2.681756146064237858e-02,2.722361087116154793e-02,-3.421246973424497007e-03,-1.332971710617597838e-01,9.965858257713067214e-03,-1.914087528866890431e-01,1.018745210134361229e-01,-1.556799035186162694e-02,-1.996634005898983433e-01,4.694245239671717557e-02,-7.164683073463857209e-03,-1.309065030306249822e-01,-5.741018675749386818e-02,1.727065947226331943e-02,-1.121532073920634559e-01],
                                                            [-2.155366966905073942e-02,9.133914293736517670e-03,1.774127766047934457e-02,1.786789482203772761e-01,8.706865128233623463e-02,5.946984356869009641e-02,8.523813303951824905e-01,2.008653057020950983e-01,1.929770532121500848e-01,1.375318291167629547e-01,3.248572819545272189e-02,6.597008241585859689e-02,-1.647365388940837672e-01,-6.812530084852026768e-02,-6.982973166859476888e-02,-2.723767760757993539e-01,-1.181006750658705751e-01,-5.595415086997732740e-02,-4.134052669184880568e-01,-8.811734134089389825e-02,-8.633440100368616754e-02,-2.965198561749005646e-01,-5.521028221833582800e-02,-1.240399733149199074e-01],
                                                            [-3.278382074899846566e-02,-2.989177243328789910e-02,-4.406023623645088927e-02,-7.309160512792006736e-02,1.298505892409671236e-01,-2.823982955259294117e-02,2.008653057020951538e-01,7.017403513443434271e-01,6.525247476373453870e-02,4.923252306724763133e-02,1.102685721303217348e-01,3.385013166186744832e-02,-6.812530084852032319e-02,-1.370668877083055792e-01,-2.438025453431137690e-02,-1.543346494248450385e-01,-2.246151767596646920e-01,-2.204177710548679836e-02,5.529612019756761226e-02,-3.161487992795582458e-01,1.009755452960071388e-02,2.294142718337353892e-02,-2.341368765348160186e-01,9.521936473639308271e-03],
                                                            [-3.950231208311034969e-02,-4.883053538175003566e-02,-3.236730661571427664e-02,5.013223673108324618e-02,2.474093967817626166e-02,1.430983448642634270e-01,1.929770532121502513e-01,6.525247476373455258e-02,7.017893985907329713e-01,-8.343162698585074311e-02,-2.390093671420091131e-02,9.696832823404001600e-02,-6.982973166859479663e-02,-2.438025453431136996e-02,-1.372155414492729764e-01,2.666337049754400126e-02,1.043685537314565336e-02,-2.152779714470135775e-01,7.240491523563001575e-02,1.486785367489984640e-02,-3.152337643076639773e-01,-1.494139049388515661e-01,-1.818639685969401440e-02,-2.417614878693716829e-01],
                                                            [9.382547808695920755e-02,7.428480437516600532e-02,-1.721136710284945290e-02,6.450856771395622330e-03,3.432047277721929357e-02,-2.681756146064239246e-02,1.375318291167629270e-01,4.923252306724758276e-02,-8.343162698585077086e-02,5.142135400667623424e-01,1.089639784460718491e-01,-6.899499646674757403e-02,-1.811955625019801841e-01,-1.033009461927316686e-01,2.369007366774234305e-02,-9.992910093262005744e-02,-5.428883975805694206e-02,4.798831491297434609e-02,-1.711515769424833133e-01,-4.166485291353125980e-02,8.797604275899179038e-02,-2.997454636647965409e-01,-6.754713980138486729e-02,3.680112067638173501e-02],
                                                            [-6.222694776158602115e-02,5.965668511023122095e-02,1.139168080655775413e-02,-1.744234773560116372e-02,-5.028907042642486759e-03,2.722361087116156181e-02,3.248572819545278434e-02,1.102685721303217625e-01,-2.390093671420090785e-02,1.089639784460720157e-01,4.252089958794121327e-01,-2.785505290022503508e-02,-1.227881256799113613e-01,-1.493682380483689898e-01,9.083903601793359012e-03,-5.428883975805699758e-02,-8.475681528453722635e-02,1.978795582964617064e-02,2.958514708646866470e-02,-1.327721146390355988e-01,-2.263570594241329226e-03,8.571140720716205474e-02,-2.232081781053808500e-01,-1.346759090049158732e-02],
                                                            [-2.421457223105452292e-02,-3.783374654386958275e-02,7.245258498973949912e-02,1.408521631713537461e-02,3.574925189680255855e-02,-3.421246973424480094e-03,6.597008241585858301e-02,3.385013166186743444e-02,9.696832823404005763e-02,-6.899499646674750464e-02,-2.785505290022501426e-02,4.196921825121562311e-01,-4.309411436644575155e-02,-1.618853229564252635e-02,-1.420276738507961212e-01,4.798831491297435303e-02,1.978795582964615676e-02,-8.302370136380422816e-02,1.138574530154020797e-01,1.448322427755354032e-02,-1.368628581723375370e-01,-1.055973835971226321e-01,-2.199323192613256497e-02,-2.237776153755736130e-01],
                                                            [-2.760697613587252963e-01,-9.543185687342826962e-02,-8.452517209373740237e-02,-2.369431636514482964e-01,-5.141143852787619789e-02,-1.332971710617597560e-01,-1.647365388940838504e-01,-6.812530084852029544e-02,-6.982973166859478276e-02,-1.811955625019802396e-01,-1.227881256799112919e-01,-4.309411436644569604e-02,3.488428619092127647e-01,1.224626515268263521e-01,1.271082309869686899e-01,1.767215035513629295e-01,7.833877405205086353e-02,6.559333966208610867e-02,1.207170283826496660e-01,4.910692754311257041e-02,4.718832265013937766e-02,2.126636325630121560e-01,8.784836880774626877e-02,9.085629589134350259e-02],
                                                            [4.798160466503319233e-02,-2.035095638001864216e-01,2.109693442732368807e-02,3.059710848067069902e-02,-1.845446372622160935e-01,9.965858257713068949e-03,-6.812530084852029544e-02,-1.370668877083055792e-01,-2.438025453431136996e-02,-1.033009461927317518e-01,-1.493682380483689620e-01,-1.618853229564251942e-02,1.224626515268263938e-01,2.976715747834214332e-01,4.363296330443636878e-02,9.508556892384578685e-02,1.401865267122381908e-01,3.162560473922775700e-02,-5.238879895261388392e-02,8.288381506551179001e-02,-3.894930057311273702e-02,-7.231188760251010261e-02,1.537474102579056423e-01,-2.680327332563425813e-02],
                                                            [7.421414414557882255e-02,2.586723357262284140e-02,-2.026377933537867326e-01,-9.858563260022125407e-02,-1.530657763972282509e-02,-1.914087528866890153e-01,-6.982973166859478276e-02,-2.438025453431137343e-02,-1.372155414492729764e-01,2.369007366774229795e-02,9.083903601793369420e-03,-1.420276738507960657e-01,1.271082309869686067e-01,4.363296330443636184e-02,2.980836001474755914e-01,-8.380836973962334235e-02,-2.612546363684060610e-02,1.252876934921137997e-01,-5.430740384558711831e-02,-3.894930057311275090e-02,8.232232371333472742e-02,8.151868905373668706e-02,2.617749590513495858e-02,1.675961441876207270e-01],
                                                            [-1.425807898618721425e-01,-3.649465668488825060e-02,1.229549582661088741e-01,-2.693307064348813840e-01,-1.270435611362291661e-01,1.018745210134361645e-01,-2.723767760757994094e-01,-1.543346494248449829e-01,2.666337049754404637e-02,-9.992910093262007132e-02,-5.428883975805696288e-02,4.798831491297435997e-02,1.767215035513629018e-01,9.508556892384574522e-02,-8.380836973962335623e-02,2.982905889636107699e-01,1.274235402090467262e-01,-9.881809110953065911e-02,1.769936800241342090e-01,8.210180072564143838e-02,-6.220419713495741604e-02,1.322116007660649462e-01,6.755079714548548053e-02,-5.465050670595202054e-02],
                                                            [2.876709545186381320e-02,-1.112528010335460116e-01,-8.604161307095254535e-03,2.621498587231775590e-02,-1.995455388125259022e-01,-1.556799035186161827e-02,-1.181006750658706445e-01,-2.246151767596646642e-01,1.043685537314565856e-02,-5.428883975805696288e-02,-8.475681528453719860e-02,1.978795582964616023e-02,7.833877405205089128e-02,1.401865267122381908e-01,-2.612546363684060263e-02,1.274235402090467539e-01,2.601900058646269276e-01,-4.386493859013647356e-02,-5.440995141111065053e-02,1.271891580679192779e-01,2.489359065141652505e-02,-3.394492935024097380e-02,9.260464124548943576e-02,3.904415203172559995e-02],
                                                            [1.040767531379037381e-01,2.387447117153721973e-02,-1.191887978535797199e-01,-4.052398326006816792e-02,-2.409363137750263409e-02,-1.996634005898983433e-01,-5.595415086997736209e-02,-2.204177710548680530e-02,-2.152779714470135775e-01,4.798831491297433222e-02,1.978795582964616717e-02,-8.302370136380422816e-02,6.559333966208615030e-02,3.162560473922776394e-02,1.252876934921138274e-01,-9.881809110953061748e-02,-4.386493859013646662e-02,2.588367362510430314e-01,-6.920740226316253463e-02,-2.433183669901083784e-02,1.400044018283624625e-01,4.684521978977452400e-02,3.904415203172559995e-02,9.302503968277661683e-02],
                                                            [-9.222081798683313958e-02,5.147920116805049934e-02,5.832223893447673752e-02,-1.705622753100509703e-01,1.145846861343014361e-01,4.694245239671720332e-02,-4.134052669184881679e-01,5.529612019756763308e-02,7.240491523563009901e-02,-1.711515769424832301e-01,2.958514708646873062e-02,1.138574530154021214e-01,1.207170283826495688e-01,-5.238879895261393943e-02,-5.430740384558715300e-02,1.769936800241341257e-01,-5.440995141111071298e-02,-6.920740226316256238e-02,3.343899085887888090e-01,-7.477446860609107682e-02,-9.103322513247184833e-02,2.152393201622828933e-01,-6.937193561657256646e-02,-7.697902834100463221e-02],
                                                            [5.147920116805045770e-02,-7.663920172983121337e-02,-1.652376506273956977e-02,8.433895963857482303e-02,-1.348167655509485974e-01,-7.164683073463864148e-03,-8.811734134089392600e-02,-3.161487992795582458e-01,1.486785367489985160e-02,-4.166485291353132919e-02,-1.327721146390356266e-01,1.448322427755353511e-02,4.910692754311265368e-02,8.288381506551181777e-02,-3.894930057311273702e-02,8.210180072564150777e-02,1.271891580679193334e-01,-2.433183669901085172e-02,-7.477446860609107682e-02,2.811170808362347673e-01,3.223583795222408066e-02,-6.247022621486311017e-02,1.691868272297078202e-01,2.538266950364954574e-02],
                                                            [5.832223893447671670e-02,-1.652376506273956283e-02,-7.778575511246049734e-02,-2.867186384259905879e-02,9.582111798331009733e-03,-1.309065030306249822e-01,-8.633440100368623693e-02,1.009755452960070000e-02,-3.152337643076640328e-01,8.797604275899174875e-02,-2.263570594241337032e-03,-1.368628581723375093e-01,4.718832265013940541e-02,-3.894930057311272315e-02,8.232232371333476906e-02,-6.220419713495738828e-02,2.489359065141653546e-02,1.400044018283624625e-01,-9.103322513247179282e-02,3.223583795222408066e-02,2.814257175597275618e-01,7.475708277010657821e-02,-1.907245870147869504e-02,1.570364375216622421e-01],
                                                            [-2.126778326607192127e-01,1.247280365341339181e-01,-2.603666438331820807e-02,-1.372787065363660908e-01,5.699668275299365344e-02,-5.741018675749384736e-02,-2.965198561749005091e-01,2.294142718337359096e-02,-1.494139049388515383e-01,-2.997454636647964854e-01,8.571140720716219352e-02,-1.055973835971225766e-01,2.126636325630120450e-01,-7.231188760251018588e-02,8.151868905373667318e-02,1.322116007660649462e-01,-3.394492935024103625e-02,4.684521978977450318e-02,2.152393201622829488e-01,-6.247022621486315874e-02,7.475708277010656433e-02,3.861073055454223302e-01,-1.216505105100489648e-01,1.353371480631684609e-01],
                                                            [1.013840194401167821e-01,-1.721125034676380672e-01,1.396906331951584465e-02,5.699668275299358405e-02,-1.116574283682880558e-01,1.727065947226331943e-02,-5.521028221833586269e-02,-2.341368765348159908e-01,-1.818639685969401787e-02,-6.754713980138497831e-02,-2.232081781053809333e-01,-2.199323192613257538e-02,8.784836880774636592e-02,1.537474102579056978e-01,2.617749590513497940e-02,6.755079714548553604e-02,9.260464124548943576e-02,3.904415203172559301e-02,-6.937193561657252483e-02,1.691868272297077924e-01,-1.907245870147870545e-02,-1.216505105100488815e-01,3.255761077430200934e-01,-3.720928324133443432e-02],
                                                            [5.008513048847667432e-02,-1.373927001381747802e-02,-1.657985816500781584e-01,-5.741018675749383349e-02,1.727065947226331596e-02,-1.121532073920634281e-01,-1.240399733149199629e-01,9.521936473639310006e-03,-2.417614878693716551e-01,3.680112067638167256e-02,-1.346759090049156997e-02,-2.237776153755735853e-01,9.085629589134350259e-02,-2.680327332563425813e-02,1.675961441876206992e-01,-5.465050670595200666e-02,3.904415203172559301e-02,9.302503968277660296e-02,-7.697902834100457670e-02,2.538266950364954228e-02,1.570364375216622144e-01,1.353371480631685164e-01,-3.720928324133444126e-02,3.258332708950273937e-01]
                                                        ]),
                                    rtol=1e-5, atol=1e-6)
        
        np.testing.assert_allclose(residuals.flatten(),jnp.array([-6.402357502297006953e-02,
                                                                    -1.345561158440171899e-02,
                                                                    -2.323912250480765843e-02,
                                                                    -7.382936148504275209e-02,
                                                                    -1.790308194444448220e-02,
                                                                    -6.022308445512819519e-02,
                                                                    -7.219620411431622309e-02,
                                                                    -4.242958771581195609e-02,
                                                                    -5.491374054807691973e-02,
                                                                    -6.243610419818378110e-02,
                                                                    -4.336195198611113300e-02,
                                                                    -2.841940233814103933e-02,
                                                                    3.517358592539177042e-02,
                                                                    -2.382330891844724671e-02,
                                                                    -4.585385760844012948e-02,
                                                                    2.719279741809119480e-02,
                                                                    -2.427870003561249587e-02,
                                                                    -9.035721672008545369e-02,
                                                                    3.028627259579769887e-02,
                                                                    -5.652287147507119303e-02,
                                                                    -7.792047708440166809e-02,
                                                                    3.796194621456553536e-02,
                                                                    -6.196617167343300425e-02,
                                                                    -4.468502674091878735e-02
                                                                    ]),
                                    rtol=1e-5, atol=1e-6)
        
    def test_quad(self):
                
        quad_points_coordinates = jnp.array([[3.00,0.00,0.00],
                                            [2.00,0.75,0.00],
                                            [0.75,1.00,0.00],
                                            [0.00,0.00,0.00]])
        
        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(quad_points_coordinates))
        fe_mesh.nodes_coordinates = quad_points_coordinates
        fe_mesh.elements_nodes = {"quad":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss2DQuad("mechanical_loss_2d",
                                                  loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                 "material_dict":{"young_modulus":1, "poisson_ratio":0.3},
                                                                 "body_foce":jnp.array([[1],[2]])},
                                                                 fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(quad_points_coordinates,
                                                                     jnp.ones((4)),
                                                                     jnp.ones((8,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[6.562684851111816320e-01,-2.541035830845668753e-01,-6.170954338106267034e-01,-1.176901811211712584e-01,-3.064091938727989683e-01,3.046137896870322881e-01,2.672361425722439843e-01,6.717997451870588721e-02],
                                                            [-2.541035830845668197e-01,9.899187855908446743e-01,-2.153633496732520677e-02,-1.162907432136077279e+00,3.046137896870322326e-01,-4.739732720517879083e-01,-2.897387163514018524e-02,6.469619185970203468e-01],
                                                            [-6.170954338106267034e-01,-2.153633496732512004e-02,1.304573748153281088e+00,4.964504114368255561e-01,-1.130456957303457022e-01,-8.387627011608084215e-02,-5.744326186123085431e-01,-3.910378063534195592e-01],
                                                            [-1.176901811211713833e-01,-1.162907432136077057e+00,4.964504114368256116e-01,1.904361998839171122e+00,1.227757603776533438e-02,8.615157779369801705e-02,-3.910378063534196147e-01,-8.276061444967919289e-01],
                                                            [-3.064091938727989683e-01,3.046137896870322881e-01,-1.130456957303457161e-01,1.227757603776525111e-02,8.540150410285284321e-01,-2.255543358744778182e-01,-4.345601514253836228e-01,-9.133702985031978694e-02],
                                                            [3.046137896870322881e-01,-4.739732720517878528e-01,-8.387627011608080052e-02,8.615157779369801705e-02,-2.255543358744777904e-01,1.281540162808572525e+00,4.816816303526317601e-03,-8.937184685504824255e-01],
                                                            [2.672361425722439843e-01,-2.897387163514026850e-02,-5.744326186123085431e-01,-3.910378063534195592e-01,-4.345601514253836228e-01,4.816816303526314132e-03,7.417566274654481262e-01,4.151948616850334450e-01],
                                                            [6.717997451870590109e-02,6.469619185970203468e-01,-3.910378063534196147e-01,-8.276061444967919289e-01,-9.133702985031981469e-02,-8.937184685504825365e-01,4.151948616850335005e-01,1.074362694450254008e+00]
                                                        ]),
                                   rtol=1e-5, atol=1e-6)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([-4.947916666666666852e-01,
                                                                    -9.895833333333332593e-01,
                                                                    -3.645833333333332038e-01,
                                                                    -7.291666666666665186e-01,
                                                                    -4.270833333333332593e-01,
                                                                    -8.541666666666665186e-01,
                                                                    -5.572916666666665186e-01,
                                                                    -1.114583333333333037e+00]),
                                   rtol=1e-5, atol=1e-6)


if __name__ == '__main__':
    unittest.main()