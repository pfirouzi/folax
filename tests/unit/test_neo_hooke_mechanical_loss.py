import pytest
import unittest 
import os
import numpy as np
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss2DQuad
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss3DTetra
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss3DHexa
from fol.tools.usefull_functions import *

class TestMechanical3D(unittest.TestCase):

    @pytest.fixture(autouse=True)
    def _request_debug_mode(self,request):
        self.debug_mode = request.config.getoption('--debug-mode')

    def test_tetra(self):

        tet_points_coordinates = jnp.array([[0.1, 0.1, 0.1],
                                            [0.28739360416666665, 0.27808503701741405, 0.05672979583333333],
                                            [0.0, 1.0, 0.0],
                                            [0.0, 1.0, 0.1]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(tet_points_coordinates))
        fe_mesh.nodes_coordinates = tet_points_coordinates
        fe_mesh.elements_nodes = {"tetra":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DTetra("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                                       "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                                                       "body_foce":jnp.array([[1],[2],[3]])},
                                                                                        fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()
        
        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(tet_points_coordinates,
                                                                        jnp.ones((4)),
                                                                        jnp.ones((12,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[6.554754433135845382e-02,1.783144233805796647e-02,3.708021913375666133e-18,-7.916517337267758858e-02,-1.261479335176647100e-02,-1.617563182067880819e-18,3.425493214725325308e-02,5.458446838512470874e-03,6.941490028678701241e-02,-2.063730310593413567e-02,-1.067509582480396894e-02,-6.941490028678701241e-02],
                                                            [1.783144233805796647e-02,2.785474261931094805e-02,1.476159709463894255e-18,-1.581992155689466301e-02,-2.579436067321518034e-02,-6.439502388773761481e-19,6.845312356674852078e-03,1.116127252678659684e-02,2.763400040064101573e-02,-8.856833137838159009e-03,-1.322165447288236456e-02,-2.763400040064101573e-02],
                                                            [3.708021913375663821e-18,1.476159709463894255e-18,2.075606376681542187e-02,-3.251891981807922340e-18,3.209324000122157712e-20,-2.332434089908727928e-02,4.627660019119145957e-02,1.842266693376070491e-02,1.009248992756441032e-02,-4.627660019119145957e-02,-1.842266693376070491e-02,-7.524212795292552040e-03],
                                                            [-7.916517337267758858e-02,-1.581992155689465954e-02,-3.251891981807921184e-18,9.780602150517743454e-02,7.735098361569417783e-03,3.075853226699100977e-19,-4.232086519258421164e-02,-3.346992853543604308e-03,-8.653846153846139755e-02,2.368001706008436569e-02,1.143181604886884910e-02,8.653846153846139755e-02],
                                                            [-1.261479335176647100e-02,-2.579436067321518034e-02,3.209324000122430352e-20,7.735098361569416915e-03,2.904959162456061464e-02,3.417614696332218595e-20,-3.346992853543590864e-03,-1.256981760553027919e-02,-9.615384615384638470e-03,8.226687843740644948e-03,9.314586654184848352e-03,9.615384615384636735e-03],
                                                            [-1.617563182067877545e-18,-6.439502388773759555e-19,-2.332434089908727928e-02,3.075853226699162125e-19,3.417614696332282994e-20,2.819013625105289481e-02,-5.769230769230773020e-02,-6.410256410256429116e-03,-1.219792951069209770e-02,5.769230769230773020e-02,6.410256410256429116e-03,7.332134158726478709e-03],
                                                            [3.425493214725325308e-02,6.845312356674850343e-03,4.627660019119145957e-02,-4.232086519258421164e-02,-3.346992853543590864e-03,-5.769230769230773020e-02,1.378397269865857255e-01,1.448250641172067364e-03,6.240894831730773445e-02,-1.297737939412547670e-01,-4.946570144303327927e-03,-5.099324081619144994e-02],
                                                            [5.458446838512472608e-03,1.116127252678659684e-02,1.842266693376070838e-02,-3.346992853543605175e-03,-1.256981760553027919e-02,-6.410256410256429116e-03,1.448250641172067364e-03,1.249663879539453099e-01,6.934327590812067350e-03,-3.559704626140934147e-03,-1.235578428752016344e-01,-1.894673811431634228e-02],
                                                            [6.941490028678701241e-02,2.763400040064101226e-02,1.009248992756441032e-02,-8.653846153846141143e-02,-9.615384615384636735e-03,-1.219792951069209770e-02,6.240894831730773445e-02,6.934327590812068218e-03,4.236239767476738804e-01,-4.528538706563334931e-02,-2.495294337606843854e-02,-4.215185371645461809e-01],
                                                            [-2.063730310593413567e-02,-8.856833137838159009e-03,-4.627660019119145263e-02,2.368001706008436569e-02,8.226687843740644948e-03,5.769230769230774408e-02,-1.297737939412547670e-01,-3.559704626140934147e-03,-4.528538706563334237e-02,1.267310799871045057e-01,4.189849920238448641e-03,3.386967956451707173e-02],
                                                            [-1.067509582480397241e-02,-1.322165447288236456e-02,-1.842266693376070838e-02,1.143181604886885083e-02,9.314586654184848352e-03,6.410256410256428249e-03,-4.946570144303327927e-03,-1.235578428752016206e-01,-2.495294337606844548e-02,4.189849920238448641e-03,1.274649106938991472e-01,3.696535389957272821e-02],
                                                            [-6.941490028678701241e-02,-2.763400040064100532e-02,-7.524212795292552040e-03,8.653846153846139755e-02,9.615384615384635000e-03,7.332134158726478709e-03,-5.099324081619143606e-02,-1.894673811431634922e-02,-4.215185371645462364e-01,3.386967956451706480e-02,3.696535389957272127e-02,4.217106158011123540e-01]
                                                            ])
                                    ,rtol=1e-5, atol=1e-6)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([-7.769281143822503880e-04,
                                                                    -1.553856228764507498e-03,
                                                                    -2.330784343146765584e-03,
                                                                    -7.769281143822615553e-04,
                                                                    -1.553856228764514654e-03,
                                                                    -2.330784343146768186e-03,
                                                                    -7.769281143822504964e-04,
                                                                    -1.553856228764507281e-03,
                                                                    -2.330784343146760813e-03,
                                                                    -7.769281143822603626e-04,
                                                                    -1.553856228764516172e-03,
                                                                    -2.330784343146772956e-03
                                                                    ])
                                   ,rtol=1e-5, atol=1e-6)

    def test_hexa(self):
        hex_points_coordinates = jnp.array([[0.24900,  0.34200,  0.19200],
                                            [0.32000,  0.18600,  0.64300],
                                            [0.16500,  0.74500,  0.70200],
                                            [0.27300,  0.75000,  0.23000],
                                            [0.00000,  0.00000,  0.00000],
                                            [0.00000,  0.00000,  1.00000],
                                            [0.00000,  1.00000,  1.00000],
                                            [0.00000,  1.00000,  0.00000]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(hex_points_coordinates))
        fe_mesh.nodes_coordinates = hex_points_coordinates
        fe_mesh.elements_nodes = {"hexahedron":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DHexa("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                  "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                  "body_foce":jnp.array([[1],[2],[3]])},
                                                   fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(hex_points_coordinates,
                                                                        jnp.ones((8)),
                                                                        jnp.ones((24,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[4.549594287962470118e-01,-5.003672039715338637e-02,-6.413355644158764968e-02,1.073997749575573424e-01,-1.725476859088432777e-02,1.962302029804054973e-05,3.525634017704366765e-03,-2.807060245945295924e-03,-1.108622960760013943e-03,9.766511370201938491e-02,1.389565478291082852e-02,-1.016072038476297304e-02,-2.731851876590649097e-01,-2.359373233506236595e-02,-1.519869644105777129e-02,-1.242665278915162930e-01,-7.150750805180927996e-03,6.020548239228439708e-02,-7.600148460799106831e-02,2.662717301795713282e-02,3.016667531093622512e-02,-1.900967513149558197e-01,6.032020457335834918e-02,2.098155046497554110e-04],
                                                        [-5.003672039715338637e-02,1.730976466485924792e-01,2.268391047668884969e-02,-1.834451218062792266e-02,3.667684881726416407e-02,-2.939363022277089853e-03,-9.425649989535034995e-03,-2.148867427500710664e-02,-2.364687285439766654e-02,-7.658832396576343779e-03,-4.841265228164587896e-03,-2.952247328173028974e-03,-9.495015658316249916e-04,-5.550459498344898629e-02,1.176930295312497883e-02,3.153736374306230408e-03,-3.028256140653814987e-02,1.385115504287603343e-03,2.662717301795714323e-02,-2.925663583698526887e-02,-8.546775032451495863e-03,5.663430713746094025e-02,-6.840076373571253587e-02,2.246929303197845243e-03],
                                                        [-6.413355644158763580e-02,2.268391047668885316e-02,1.895467330284893448e-01,-2.393871031303530794e-02,4.079867746953699456e-03,-5.042760837768752238e-03,-1.014708449922155191e-02,-2.440007798260280733e-02,-2.891527682228620111e-02,-1.126648961553218878e-02,-1.072468322560894693e-02,3.354643441036020413e-02,9.865406123044753381e-03,1.252250808133011789e-02,-5.288928364424958645e-02,5.722471316151519355e-02,6.513320632492720051e-03,-5.409055186663920545e-02,3.016667531093623900e-02,-8.546775032451495863e-03,-3.269629598487310690e-02,1.222904627388049677e-02,-2.128070696802139127e-03,-4.945899828303271240e-02],
                                                        [1.073997749575573285e-01,-1.834451218062792266e-02,-2.393871031303530100e-02,4.541187550897180514e-01,-3.964758646694585553e-02,5.597997012392454119e-02,1.686107709047049985e-01,1.625898408502804079e-02,2.908254508194845281e-02,2.097911722510589425e-02,8.451570799887966889e-03,-6.522014548608132470e-03,-2.122017861676164796e-01,-1.185737536587760411e-02,-6.271007521762103631e-02,-2.640954582844630139e-01,-3.817571464606013543e-02,2.710850556397886163e-02,-1.567426546284924060e-01,5.383359097132296711e-02,1.069470349432320028e-02,-1.180685190965144182e-01,2.948104280327255161e-02,-2.969492418491058439e-02],
                                                        [-1.725476859088432430e-02,3.667684881726416407e-02,4.079867746953697721e-03,-3.964758646694585553e-02,1.551146037940521472e-01,-1.387121256532982544e-02,-9.029477453433503581e-03,2.212569396647475622e-02,-5.087577620041460261e-03,2.784938768110655307e-04,-1.346017421700841828e-02,1.561300827553448699e-02,1.091342582840313475e-03,-5.500620699992020413e-02,6.139717778621898558e-04,-1.397699669734223799e-02,-5.473995541739705428e-02,-9.584239041413821630e-03,4.905794994568198758e-02,-4.950612535118500274e-02,-6.969183005980141834e-04,2.948104280327256549e-02,-4.120468459228038283e-02,8.933099727032746407e-03],
                                                        [1.962302029804473407e-05,-2.939363022277089420e-03,-5.042760837768749636e-03,5.597997012392454813e-02,-1.387121256532982717e-02,1.629704480874333561e-01,2.760818610758947189e-02,3.277806995343171027e-03,6.186896083636354154e-02,-6.368121527481961997e-05,1.695916212168833634e-02,-8.637194009354365321e-03,-5.722930598685185832e-02,-3.376412837522412610e-03,-7.559855387333888621e-02,4.624531205004555300e-03,-1.093039288756767792e-02,-5.509354074951414160e-02,-1.244399069779333553e-03,1.947312468632745111e-03,-3.777533779021424037e-02,-2.969492418491060173e-02,8.933099727032748141e-03,-4.269202166360651363e-02],
                                                        [3.525634017704359826e-03,-9.425649989535034995e-03,-1.014708449922155017e-02,1.686107709047049985e-01,-9.029477453433501846e-03,2.760818610758947189e-02,7.218265021033025697e-01,1.038958477769457572e-01,9.981571717869834603e-02,1.321056735351364420e-01,2.245614588358960453e-02,-1.631078849400770248e-02,-1.370416426741193350e-01,-3.523722457682081782e-02,-3.611882672513520853e-02,-2.376564915230094110e-01,-7.331798842929644622e-02,-1.052765923021002506e-03,-3.902189216999713550e-01,2.833868537203376638e-03,8.929598066174677246e-03,-2.611515246637484133e-01,-2.175521748652937092e-03,-7.272403571107703690e-02],
                                                        [-2.807060245945295057e-03,-2.148867427500710664e-02,-2.440007798260281080e-02,1.625898408502804079e-02,2.212569396647475622e-02,3.277806995343172762e-03,1.038958477769457711e-01,2.699035649507859902e-01,3.375128005020753413e-02,1.981191511435882388e-02,5.031590257581286529e-02,-1.986227212915601514e-03,-3.523722457682083864e-02,-5.403268911678462544e-02,-1.261047648326449853e-02,-6.759683458314263982e-02,-9.437169357460555019e-02,-4.371702977098059894e-04,-1.981036223202735369e-02,-9.844951878318149163e-02,6.833173651473395740e-03,-1.451526533839650641e-02,-7.400258574349485863e-02,-4.428308720531388618e-03],
                                                        [-1.108622960760016329e-03,-2.364687285439766654e-02,-2.891527682228620111e-02,2.908254508194844934e-02,-5.087577620041457659e-03,6.186896083636354154e-02,9.981571717869834603e-02,3.375128005020754107e-02,2.700507066899544006e-01,7.278955095735848216e-03,7.132362530674143247e-03,1.041517088696784603e-02,-3.611882672513522241e-02,-1.261047648326449853e-02,-5.447865033968684462e-02,-1.409763771789276920e-02,-5.565375425914927468e-03,-6.636007763665215109e-02,-1.613450449792784569e-02,6.079968523268267956e-03,-9.570441386749863055e-02,-6.871762545466678085e-02,-5.330872053139644115e-05,-9.687641974716190707e-02],
                                                        [9.766511370201937103e-02,-7.658832396576343779e-03,-1.126648961553218878e-02,2.097911722510589771e-02,2.784938768110653139e-04,-6.368121527482166640e-05,1.321056735351364420e-01,1.981191511435882388e-02,7.278955095735845614e-03,4.369201712850345198e-01,5.636067850658886547e-02,-3.568706713797288599e-02,-1.591054879931444177e-01,-6.000977322966227073e-02,-1.029072228503157341e-02,-8.198964781673896696e-02,-2.808043435761565024e-02,2.482154219636603307e-02,-1.548487242480411918e-01,2.500938148173463375e-03,5.424158710345729217e-02,-2.917262156893716818e-01,1.679701433792203311e-02,-2.903412414174769487e-02],
                                                        [1.389565478291082505e-02,-4.841265228164587896e-03,-1.072468322560894520e-02,8.451570799887970359e-03,-1.346017421700842175e-02,1.695916212168833634e-02,2.245614588358960800e-02,5.031590257581286529e-02,7.132362530674144115e-03,5.636067850658887934e-02,1.699065387229843627e-01,-1.440778598287501509e-02,-5.693285015273923805e-02,-6.362351463231079307e-02,-3.832596280239494550e-03,-2.808043435761567105e-02,-3.647279087249041124e-02,1.023514956705836101e-02,-8.749061851826507585e-03,-3.971033733769823576e-02,4.482370647540949958e-03,-7.401703610795843519e-03,-6.211435901112480340e-02,-9.843979378238339184e-03],
                                                        [-1.016072038476297131e-02,-2.952247328173028106e-03,3.354643441036019719e-02,-6.522014548608133337e-03,1.561300827553448525e-02,-8.637194009354365321e-03,-1.631078849400771288e-02,-1.986227212915600646e-03,1.041517088696784950e-02,-3.568706713797288599e-02,-1.440778598287501509e-02,1.533560986212168242e-01,2.541495098401935640e-04,1.577883351451074816e-04,-4.160182203959211095e-02,2.482154219636605041e-02,1.023514956705835754e-02,-3.127344911029142360e-02,5.015504864191886597e-02,1.838139878310187736e-03,-5.198256793760389766e-02,-6.550149782773403290e-03,-8.497825532084489833e-03,-6.382267082170306471e-02],
                                                        [-2.731851876590649097e-01,-9.495015658316246663e-04,9.865406123044749911e-03,-2.122017861676165074e-01,1.091342582840311090e-03,-5.722930598685186526e-02,-1.370416426741193350e-01,-3.523722457682083864e-02,-3.611882672513522241e-02,-1.591054879931444455e-01,-5.693285015273923111e-02,2.541495098401913414e-04,2.780420472814471022e-01,6.334275078973773676e-02,6.574563671739755422e-02,1.704120574291003443e-01,4.617323856803690063e-02,-1.650565543561413953e-02,1.295356271182570851e-01,-8.861580360105309265e-03,-9.853962201298360757e-03,2.035443726651405549e-01,-8.626175285117934285e-03,4.384255799861708908e-02],
                                                        [-2.359373233506236942e-02,-5.550459498344897935e-02,1.252250808133011789e-02,-1.185737536587760411e-02,-5.500620699992021800e-02,-3.376412837522413911e-03,-3.523722457682081782e-02,-5.403268911678462544e-02,-1.261047648326450027e-02,-6.000977322966227073e-02,-6.362351463231077919e-02,1.577883351451069395e-04,6.334275078973773676e-02,1.245281859040734823e-01,2.256877412298431695e-02,4.352900779880614079e-02,6.080712691172619755e-02,-3.136844586694729868e-03,7.164060665535655972e-03,1.603598716684360992e-02,-2.014618995161003220e-02,1.666228625334351815e-02,2.679570574982133302e-02,4.020853319632132841e-03],
                                                        [-1.519869644105776955e-02,1.176930295312497883e-02,-5.288928364424959339e-02,-6.271007521762103631e-02,6.139717778621903979e-04,-7.559855387333888621e-02,-3.611882672513521547e-02,-1.261047648326449853e-02,-5.447865033968684462e-02,-1.029072228503156994e-02,-3.832596280239494984e-03,-4.160182203959211789e-02,6.574563671739754034e-02,2.256877412298431695e-02,1.257642619962356934e-01,7.084088154129367793e-03,5.981745156894982367e-03,1.611062725135296858e-02,6.171678824342609684e-03,-2.014618995161002180e-02,1.435151311031239614e-02,4.531691697297605959e-02,-4.344531295752451609e-03,6.834190753896637882e-02],
                                                        [-1.242665278915162791e-01,3.153736374306229540e-03,5.722471316151519355e-02,-2.640954582844630694e-01,-1.397699669734224145e-02,4.624531205004558769e-03,-2.376564915230094110e-01,-6.759683458314263982e-02,-1.409763771789277267e-02,-8.198964781673896696e-02,-2.808043435761567105e-02,2.482154219636605041e-02,1.704120574291003165e-01,4.352900779880614079e-02,7.084088154129367793e-03,2.299356331314173496e-01,6.590872769433449296e-02,-5.111280574630892859e-02,1.696083703066404436e-01,-3.615558422192491524e-03,-3.453864308041562636e-02,1.380520646485695890e-01,6.783521928461848892e-04,5.994211827602165775e-03],
                                                        [-7.150750805180927129e-03,-3.028256140653814640e-02,6.513320632492718316e-03,-3.817571464606013543e-02,-5.473995541739705428e-02,-1.093039288756767619e-02,-7.331798842929644622e-02,-9.437169357460556407e-02,-5.565375425914928335e-03,-2.808043435761564677e-02,-3.647279087249041124e-02,1.023514956705835754e-02,4.617323856803690757e-02,6.080712691172619061e-02,5.981745156894980632e-03,6.590872769433449296e-02,1.156338838344661557e-01,-2.268876133972574580e-02,1.793892875729461572e-02,2.019480443799573366e-02,-3.740936754130255466e-03,1.670399321848715576e-02,1.923118608684309949e-02,2.019525105089254452e-02],
                                                        [6.020548239228438320e-02,1.385115504287602909e-03,-5.409055186663921239e-02,2.710850556397885469e-02,-9.584239041413823365e-03,-5.509354074951415547e-02,-1.052765923021003157e-03,-4.371702977098059352e-04,-6.636007763665215109e-02,2.482154219636603307e-02,1.023514956705836275e-02,-3.127344911029142360e-02,-1.650565543561413606e-02,-3.136844586694732904e-03,1.611062725135297205e-02,-5.111280574630892859e-02,-2.268876133972574233e-02,1.115740749937141618e-01,-3.343287384964638981e-02,4.031499143305602648e-03,5.864053571932521802e-02,-1.003142919803880380e-02,2.019525105089253758e-02,2.049238139870458372e-02],
                                                        [-7.600148460799106831e-02,2.662717301795714323e-02,3.016667531093623553e-02,-1.567426546284924060e-01,4.905794994568198758e-02,-1.244399069779333986e-03,-3.902189216999713550e-01,-1.981036223202735022e-02,-1.613450449792785263e-02,-1.548487242480411641e-01,-8.749061851826507585e-03,5.015504864191885903e-02,1.295356271182570851e-01,7.164060665535655972e-03,6.171678824342612286e-03,1.696083703066404436e-01,1.793892875729461225e-02,-3.343287384964639675e-02,2.734617607618232693e-01,-3.867644927901259938e-02,-4.708615093058886314e-02,2.052060269977752649e-01,-3.355223902360294358e-02,1.140452557074471754e-02],
                                                        [2.662717301795712935e-02,-2.925663583698526887e-02,-8.546775032451497597e-03,5.383359097132296711e-02,-4.950612535118500968e-02,1.947312468632746195e-03,2.833868537203380108e-03,-9.844951878318149163e-02,6.079968523268266221e-03,2.500938148173467712e-03,-3.971033733769823576e-02,1.838139878310187953e-03,-8.861580360105316204e-03,1.603598716684360992e-02,-2.014618995161002180e-02,-3.615558422192494559e-03,2.019480443799574407e-02,4.031499143305600046e-03,-3.867644927901260632e-02,1.136432775041608806e-01,1.667370928563314050e-02,-3.464198261334652806e-02,6.704854820004979565e-02,-1.877664315088424128e-03],
                                                        [3.016667531093622165e-02,-8.546775032451495863e-03,-3.269629598487310690e-02,1.069470349432320028e-02,-6.969183005980135329e-04,-3.777533779021423344e-02,8.929598066174684184e-03,6.833173651473395740e-03,-9.570441386749865831e-02,5.424158710345728523e-02,4.482370647540950825e-03,-5.198256793760389766e-02,-9.853962201298360757e-03,-2.014618995161003567e-02,1.435151311031239441e-02,-3.453864308041562636e-02,-3.740936754130253297e-03,5.864053571932521802e-02,-4.708615093058887008e-02,1.667370928563314050e-02,1.145691876746393195e-01,-1.255380776258854282e-02,5.141566454142311622e-03,3.059737907591298170e-02],
                                                        [-1.900967513149558197e-01,5.663430713746094025e-02,1.222904627388049330e-02,-1.180685190965144182e-01,2.948104280327256549e-02,-2.969492418491060173e-02,-2.611515246637484133e-01,-1.451526533839650121e-02,-6.871762545466679473e-02,-2.917262156893716818e-01,-7.401703610795840917e-03,-6.550149782773399820e-03,2.035443726651405272e-01,1.666228625334352162e-02,4.531691697297605959e-02,1.380520646485695890e-01,1.670399321848715576e-02,-1.003142919803880380e-02,2.052060269977752371e-01,-3.464198261334653500e-02,-1.255380776258854456e-02,3.142405464531050074e-01,-6.292267785002531033e-02,7.000197313612159522e-02],
                                                        [6.032020457335834918e-02,-6.840076373571253587e-02,-2.128070696802139561e-03,2.948104280327254814e-02,-4.120468459228038283e-02,8.933099727032748141e-03,-2.175521748652937959e-03,-7.400258574349487251e-02,-5.330872053139501136e-05,1.679701433792203658e-02,-6.211435901112480340e-02,-8.497825532084491568e-03,-8.626175285117936020e-03,2.679570574982133649e-02,-4.344531295752449875e-03,6.783521928461855397e-04,1.923118608684310643e-02,2.019525105089253758e-02,-3.355223902360294358e-02,6.704854820004978178e-02,5.141566454142310755e-03,-6.292267785002529645e-02,1.326469530458983803e-01,-1.924618098689711773e-02],
                                                        [2.098155046497543811e-04,2.246929303197846978e-03,-4.945899828303271240e-02,-2.969492418491059132e-02,8.933099727032744672e-03,-4.269202166360651363e-02,-7.272403571107703690e-02,-4.428308720531386883e-03,-9.687641974716190707e-02,-2.903412414174768100e-02,-9.843979378238337449e-03,-6.382267082170306471e-02,4.384255799861708908e-02,4.020853319632133709e-03,6.834190753896637882e-02,5.994211827602164040e-03,2.019525105089254452e-02,2.049238139870458372e-02,1.140452557074471407e-02,-1.877664315088423694e-03,3.059737907591298517e-02,7.000197313612158134e-02,-1.924618098689711773e-02,1.334184425019202258e-01]
                                                        ]),
                                    rtol=1e-5, atol=1e-6)
        
        np.testing.assert_allclose(residuals.flatten(),jnp.array([-1.405296604861111867e-02,
                                                                    -2.810593209722221306e-02,
                                                                    -4.215889814583331091e-02,
                                                                    -1.508404097222225231e-02,
                                                                    -3.016808194444444563e-02,
                                                                    -4.525212291666665110e-02,
                                                                    -1.219633231944445423e-02,
                                                                    -2.439266463888888070e-02,
                                                                    -3.658899695833332105e-02,
                                                                    -1.326222599305559337e-02,
                                                                    -2.652445198611112082e-02,
                                                                    -3.978667797916666388e-02,
                                                                    -2.253365766435181175e-02,
                                                                    -4.506731532870367207e-02,
                                                                    -6.760097299305550811e-02,
                                                                    -2.339274745370366337e-02,
                                                                    -4.678549490740737532e-02,
                                                                    -7.017824236111110114e-02,
                                                                    -1.992568253240738912e-02,
                                                                    -3.985136506481480601e-02,
                                                                    -5.977704759722220207e-02,
                                                                    -2.142298968287033659e-02,
                                                                    -4.284597936574072868e-02,
                                                                    -6.426896904861108262e-02
                                                                    ]),
                                    rtol=1e-5, atol=1e-6)
        
    def test_quad(self):
                
        quad_points_coordinates = jnp.array([[3.00,0.00,0.00],
                                            [2.00,0.75,0.00],
                                            [0.75,1.00,0.00],
                                            [0.00,0.00,0.00]])
        
        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(quad_points_coordinates))
        fe_mesh.nodes_coordinates = quad_points_coordinates
        fe_mesh.elements_nodes = {"quad":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss2DQuad("mechanical_loss_2d",
                                                  loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                 "material_dict":{"young_modulus":1, "poisson_ratio":0.3},
                                                                 "body_foce":jnp.array([[1],[2]])},
                                                                 fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(quad_points_coordinates,
                                                                     jnp.ones((4)),
                                                                     jnp.ones((8,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[3.825861228992937235e-01,-1.573022180999699704e-01,-2.800459554821382313e-01,-2.706828062079837116e-02,-1.745809180037808384e-01,1.885704412348295222e-01,7.204075058662530451e-02,-4.199942514061172881e-03],
                                                            [-1.573022180999699982e-01,8.645254458143624143e-01,-5.911956267208039184e-02,-1.068441064174455502e+00,1.885704412348295222e-01,-4.166179198178758813e-01,2.785133953722086081e-02,6.205335381779689685e-01],
                                                            [-2.800459554821382313e-01,-5.911956267208038490e-02,7.823255614967252747e-01,3.073264451751777093e-01,-1.540518634302365242e-01,-6.135859522409011467e-03,-3.482277425843506302e-01,-2.420710229806883051e-01],
                                                            [-2.706828062079835381e-02,-1.068441064174455502e+00,3.073264451751777093e-01,1.648686368043011052e+00,-3.818714157369108159e-02,1.336775316600489205e-01,-2.420710229806883051e-01,-7.139228355286042493e-01],
                                                            [-1.745809180037808384e-01,1.885704412348295222e-01,-1.540518634302365242e-01,-3.818714157369106771e-02,5.001542821880619050e-01,-1.396288745889624483e-01,-1.715215007540445702e-01,-1.075442507217599757e-02],
                                                            [1.885704412348295222e-01,-4.166179198178758813e-01,-6.135859522409021875e-03,1.336775316600488650e-01,-1.396288745889624483e-01,1.117690569203681150e+00,-4.280570712345804080e-02,-8.347501810458540783e-01],
                                                            [7.204075058662529063e-02,2.785133953722085040e-02,-3.482277425843506302e-01,-2.420710229806882774e-01,-1.715215007540445702e-01,-4.280570712345804774e-02,4.477084927517698820e-01,2.570253905669254713e-01],
                                                            [-4.199942514061168544e-03,6.205335381779688575e-01,-2.420710229806883051e-01,-7.139228355286042493e-01,-1.075442507217599757e-02,-8.347501810458540783e-01,2.570253905669254713e-01,9.281394783964894701e-01]
                                                        ]),
                                   rtol=1e-5, atol=1e-6)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([-4.947916666666666297e-01,
                                                                    -9.895833333333332593e-01,
                                                                    -3.645833333333332038e-01,
                                                                    -7.291666666666665186e-01,
                                                                    -4.270833333333332593e-01,
                                                                    -8.541666666666665186e-01,
                                                                    -5.572916666666665186e-01,
                                                                    -1.114583333333333037e+00]),
                                   rtol=1e-5, atol=1e-6)


if __name__ == '__main__':
    unittest.main()